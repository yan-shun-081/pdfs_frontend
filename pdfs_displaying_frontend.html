<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìö PDF Stream</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
        rel="stylesheet"/>

  <style>
    /* ------------------------------------------------------------------
       General layout & theme
    ------------------------------------------------------------------- */
    * { box-sizing:border-box; margin:0; padding:0; }

    body {
      font-family:'Poppins',sans-serif;
      background:linear-gradient(135deg,#0f172a,#1e293b);
      color:#fff;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding-bottom:40px;
    }

    header{
      width:100%; padding:16px; text-align:center;
      background:rgba(255,255,255,0.08);
      backdrop-filter:blur(12px);
      box-shadow:0 4px 20px rgba(0,0,0,.3);
      font-size:1.5em; font-weight:600; color:#60a5fa;
      letter-spacing:1px;
    }

    #feed{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:16px;
      width:92%; max-width:1300px;
      margin-top:24px;
    }

    .card{
      background:rgba(255,255,255,0.08);
      border-radius:16px;
      padding:14px;
      display:flex;
      flex-direction:column;
      transition:transform .25s ease,box-shadow .25s ease;
    }
    .card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 20px rgba(0,0,0,.4);
    }

    .preview{
      width:100%; aspect-ratio:16/9;
      border-radius:12px;
      overflow:hidden;
      background:#1e293b;
      display:flex; align-items:center; justify-content:center;
      color:#94a3b8; font-size:.9em;
    }
    .preview iframe{ width:100%; height:100%; border:none; }

    .info{ margin-top:10px; }
    .title{
      font-size:1em; font-weight:600; color:#f8fafc;
      margin-bottom:4px; line-height:1.4; word-break:break-word;
    }
    .meta{
      font-size:.85em; color:#94a3b8; word-break:break-word;
    }

    .open-btn{
      margin-top:10px; background:#60a5fa; color:#fff;
      border:none; border-radius:8px; padding:10px;
      font-weight:500; cursor:pointer;
      transition:background .25s ease; font-size:.95em;
    }
    .open-btn:hover{ background:#3b82f6; }

    footer{
      margin-top:30px; color:#94a3b8; font-size:.9em; text-align:center;
    }

    .loader{
      margin-top:60px;
      border:6px solid rgba(255,255,255,.2);
      border-top:6px solid #60a5fa;
      border-radius:50%; width:45px; height:45px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

    /* ------------------------------------------------------------------
       Full‚Äëscreen PDF viewer
    ------------------------------------------------------------------- */
    .pdf-viewer{
      position:fixed; top:0; left:0;
      width:100vw; height:100vh;
      background:#0f172a;
      z-index:999; display:none; flex-direction:column;
    }
    .pdf-viewer.active{ display:flex; }

    .pdf-toolbar{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 14px;
      background:rgba(15,23,42,.9);
      border-bottom:1px solid rgba(255,255,255,.1);
    }
    .pdf-toolbar h2{
      font-size:1em; color:#93c5fd; font-weight:500;
      overflow:hidden; text-overflow:ellipsis;
      white-space:nowrap; max-width:80%;
    }
    .close-full{
      background:#ef4444; border:none; color:#fff;
      font-size:1.2em; width:36px; height:36px;
      border-radius:50%; cursor:pointer;
      transition:background .25s ease;
    }
    .close-full:hover{ background:#dc2626; }
    .pdf-iframe{
      flex-grow:1; border:none; width:100%; height:100%;
    }

    /* ------------------------------------------------------------------
       Modal (watch‚Äëad popup)
    ------------------------------------------------------------------- */
    .modal{
      position:fixed; top:0; left:0;
      width:100vw; height:100vh;
      background:rgba(0,0,0,.6);
      display:none; justify-content:center; align-items:center;
      z-index:1000;
    }
    .modal-content{
      background:#1e293b;
      padding:20px; border-radius:12px;
      text-align:center; max-width:90%;
    }
    .modal-content p{
      color:#f8fafc; margin-bottom:15px;
    }
    .modal-content button{
      margin:5px; padding:10px 20px;
      border:none; border-radius:6px;
      font-size:.95em; cursor:pointer;
    }
    .btn-watch{ background:#60a5fa; color:#fff; }
    .btn-watch:hover{ background:#3b82f6; }
    .btn-cancel{ background:#64748b; color:#fff; }
    .btn-cancel:hover{ background:#475569; }

    /* ------------------------------------------------------------------
       Responsiveness
    ------------------------------------------------------------------- */
    @media(max-width:768px){
      header{font-size:1.3em;padding:12px}
      .open-btn{font-size:.9em;padding:8px}
      .meta{font-size:.8em}
    }
    @media(max-width:480px){
      #feed{width:96%;gap:12px}
      .card{padding:10px}
      .preview{aspect-ratio:4/3}
      .title{font-size:.95em}
      .pdf-toolbar h2{font-size:.9em}
      .close-full{width:32px;height:32px;font-size:1em}
    }
  </style>
</head>

<body>
  <!-- ------------------------------------------------------------
       DEBUG PANEL ‚Äì appears when you tap the tiny ‚Äúü™µ‚ÄØDebug‚Äù button.
       ------------------------------------------------------------ -->
  <div id="debugPanel" style="
        position:fixed; top:0; left:0; right:0; height:200px;
        background:rgba(0,0,0,0.85); color:#0f0; font-family:monospace;
        font-size:12px; line-height:1.3; overflow-y:auto; z-index:9999;
        display:none; padding:8px 8px 30px 8px;">
    <button id="debugCloseBtn" style="
        position:absolute; top:4px; right:4px;
        background:#222; color:#fff; border:none; padding:2px 6px;
        font-size:10px; cursor:pointer;">‚úï</button>
    <div id="debugLog"></div>
  </div>

  <!-- tiny button that opens the panel -->
  <button id="debugOpenBtn" style="
        position:fixed; bottom:12px; right:12px;
        background:#222; color:#0f0; border:none; border-radius:4px;
        padding:6px 10px; font-size:12px; cursor:pointer;
        z-index:9999;">ü™µ Debug</button>

  <!-- ------------------------------------------------------------------
       THE ORIGINAL UI (header, feed, loader, footer, viewer, modal)
       ------------------------------------------------------------------ -->
  <header>üìö PDF Stream</header>

  <div id="feed"></div>
  <div id="loader" class="loader"></div>

  <footer>Powered by Archive & Your Backend</footer>

  <!-- Full‚Äëscreen PDF viewer -->
  <div id="pdfViewer" class="pdf-viewer">
    <div class="pdf-toolbar">
      <h2 id="pdfTitle">PDF Viewer</h2>
      <button class="close-full" id="closeViewer">&times;</button>
    </div>
    <iframe id="pdfFrame" class="pdf-iframe" src=""></iframe>
  </div>

  <!-- Watch‚ÄëAd modal -->
  <div id="adModal" class="modal">
    <div class="modal-content">
      <p>Watch an ad to view this PDF</p>
      <button id="watchAdBtn" class="btn-watch">Watch Ad</button>
      <button id="cancelBtn" class="btn-cancel">Cancel</button>
    </div>
  </div>

  <!-- ------------------------------------------------------------
       DEBUGGER SCRIPT ‚Äì runs once, wraps console, Android bridge,
       network, and then executes the original app logic.
       ------------------------------------------------------------ -->
  <script>
    (function () {
      /* --------------------------------------------------------
         0Ô∏è‚É£  QUICK HELPER ‚Äì writes a line to the on‚Äëpage panel
              and also forwards to the real console (so Logcat still
              gets the messages).
         -------------------------------------------------------- */
      const LOG_CONTAINER = document.getElementById('debugLog');

      function dLog(...args) {
        // 1Ô∏è‚É£ forward to the real console (so Logcat still sees it)
        console.__origLog.apply(console, args);
        // 2Ô∏è‚É£ write to the UI panel
        const line = document.createElement('div');
        line.textContent = args.map(a => {
          try { return typeof a === 'object' ? JSON.stringify(a) : String(a); }
          catch (e) { return String(a); }
        }).join(' ');
        LOG_CONTAINER.appendChild(line);
        LOG_CONTAINER.scrollTop = LOG_CONTAINER.scrollHeight; // auto‚Äëscroll
      }

      /* --------------------------------------------------------
         Preserve the original console methods ‚Äì we‚Äôll call them
         from our wrappers.
         -------------------------------------------------------- */
      console.__origLog   = console.log   || function () {};
      console.__origWarn  = console.warn  || function () {};
      console.__origError = console.error || function () {};
      console.__origInfo  = console.info  || function () {};

      /* --------------------------------------------------------
         Override console.* so every call appears in the panel.
         -------------------------------------------------------- */
      console.log   = (...a) => dLog('[LOG]',   ...a);
      console.warn  = (...a) => dLog('[WARN]',  ...a);
      console.error = (...a) => dLog('[ERR]',   ...a);
      console.info  = (...a) => dLog('[INFO]',  ...a);

      /* --------------------------------------------------------
         1Ô∏è‚É£  UI ‚Äì open / close the debug panel
         -------------------------------------------------------- */
      const panel    = document.getElementById('debugPanel');
      const openBtn  = document.getElementById('debugOpenBtn');
      const closeBtn = document.getElementById('debugCloseBtn');

      openBtn.addEventListener('click', () => panel.style.display = 'block');
      closeBtn.addEventListener('click', () => panel.style.display = 'none');

      /* --------------------------------------------------------
         2Ô∏è‚É£  WRAP THE ANDROID BRIDGE (if it exists) and log every call
         -------------------------------------------------------- */
      if (window.Android) {
        const orig = {
          requestRewardedAd   : window.Android.requestRewardedAd,
          preloadRewardedAd   : window.Android.preloadRewardedAd,
          loadUrlInWebView    : window.Android.loadUrlInWebView,
          getAndroidId       : window.Android.getAndroidId
        };

        const wrap = (name, fn) => (...args) => {
          console.log(`üîπ Android.${name} called with`, ...args);
          const ret = fn.apply(window.Android, args);
          if (ret !== undefined) {
            console.log(`üîπ Android.${name} returned ‚Üí`, ret);
          }
          return ret;
        };

        window.Android.requestRewardedAd   = wrap('requestRewardedAd',   orig.requestRewardedAd);
        window.Android.preloadRewardedAd   = wrap('preloadRewardedAd',   orig.preloadRewardedAd);
        window.Android.loadUrlInWebView    = wrap('loadUrlInWebView',    orig.loadUrlInWebView);
        window.Android.getAndroidId        = wrap('getAndroidId',        orig.getAndroidId);
      } else {
        console.warn('‚ö†Ô∏è No Android bridge detected ‚Äì running in a browser');
      }

      /* --------------------------------------------------------
         3Ô∏è‚É£  INTERCEPT THE CALLBACKS THAT Android WILL CALL
         -------------------------------------------------------- */
      const origOnAdPreloaded       = window.onAdPreloaded       || function () {};
      const origOnAdFailedToPreload = window.onAdFailedToPreload || function () {};
      const origOnAdNotAvailable    = window.onAdNotAvailable    || function () {};
      const origOnAdCompleted       = window.onAdCompleted       || function () {};

      window.onAdPreloaded = function () {
        console.log('‚úÖ onAdPreloaded');
        origOnAdPreloaded();
      };
      window.onAdFailedToPreload = function () {
        console.warn('‚ö†Ô∏è onAdFailedToPreload');
        origOnAdFailedToPreload();
      };
      window.onAdNotAvailable = function () {
        console.warn('‚ö†Ô∏è onAdNotAvailable');
        origOnAdNotAvailable();
      };
      window.onAdCompleted = function (tag) {
        console.log('‚úÖ onAdCompleted, tag =', tag);
        origOnAdCompleted(tag);
      };

      /* --------------------------------------------------------
         4Ô∏è‚É£  INTERCEPT NETWORK ‚Äì fetch() and XHR (Archive.org uses XHR)
         -------------------------------------------------------- */
      // ---- fetch -------------------------------------------------
      const origFetch = window.fetch;
      window.fetch = function (...args) {
        console.log('üîó fetch ‚Üí', ...args);
        return origFetch.apply(this, args)
          .then(resp => {
            console.log('üîó fetch response ‚Üí', {
              url: resp.url,
              status: resp.status,
              ok: resp.ok,
              type: resp.type
            });
            return resp;
          })
          .catch(err => {
            console.error('üîó fetch error ‚Üí', err);
            throw err;
          });
      };

      // ---- XHR ---------------------------------------------------
      const origOpen = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function (method, url, async, user, pwd) {
        this.__debugInfo = { method, url };
        console.log('üîó XHR open ‚Üí', method, url);
        return origOpen.apply(this, arguments);
      };
      const origSend = XMLHttpRequest.prototype.send;
      XMLHttpRequest.prototype.send = function (body) {
        const info = this.__debugInfo || {};
        console.log('üîó XHR send ‚Üí', info.method, info.url, 'body:', body);
        this.addEventListener('load', function () {
          console.log('üîó XHR load ‚Üí', {
            url: info.url,
            status: this.status,
            responseURL: this.responseURL,
            responseSnippet: this.responseText?.slice(0, 200)
          });
        });
        this.addEventListener('error', function () {
          console.error('üîó XHR error ‚Üí', info.url);
        });
        return origSend.apply(this, arguments);
      };

      /* --------------------------------------------------------
         5Ô∏è‚É£  ORIGINAL APP LOGIC ‚Äì unchanged, but now every
              `console.log` call will appear in the debug panel.
         -------------------------------------------------------- */

      // ------------------- Global elements / state -------------------
      const FEED          = document.getElementById('feed');
      const LOADER        = document.getElementById('loader');
      const VIEWER        = document.getElementById('pdfViewer');
      const PDF_FRAME     = document.getElementById('pdfFrame');
      const PDF_TITLE     = document.getElementById('pdfTitle');
      const CLOSE_VIEWER  = document.getElementById('closeViewer');

      const AD_MODAL      = document.getElementById('adModal');
      const WATCH_BTN     = document.getElementById('watchAdBtn');
      const CANCEL_BTN    = document.getElementById('cancelBtn');

      const BACKEND_URL   = 'https://pdfs_displaying_backend.video-api-ajaiahar.workers.dev';

      let allData = [], currentIndex = 0;
      const BATCH_SIZE = 30;
      let loadingMore = false;

      // Holds the data for the PDF that the user is about to view
      let pendingPayload = null;   // {title:string, url:string}

      // -----------------------------------------------------------------
      // Helper ‚Äì open PDF in the full‚Äëscreen viewer
      // -----------------------------------------------------------------
      function openFullscreenPDF(title, url) {
        if (!url) {
          console.warn('openFullscreenPDF called with empty URL');
          return;
        }
        const embedUrl = url.includes('archive.org')
          ? url.replace('/details/', '/embed/')
          : url;
        console.log('üîó embedUrl that will be set on iframe =', embedUrl);
        PDF_TITLE.textContent = title || 'PDF Viewer';
        PDF_FRAME.src = embedUrl;
        VIEWER.classList.add('active');
      }

      // -----------------------------------------------------------------
      // Show modal and keep a copy of the payload
      // -----------------------------------------------------------------
      function showAdModal(item) {
        pendingPayload = {
          title: item.title || 'Untitled PDF',
          url:   item.archive_url || ''
        };
        console.log('üü† showAdModal ‚Üí pendingPayload =', pendingPayload);
        AD_MODAL.style.display = 'flex';
      }

      // -----------------------------------------------------------------
      // ‚ÄúWatch Ad‚Äù ‚Äì send JSON payload to Android
      // -----------------------------------------------------------------
      WATCH_BTN.addEventListener('click', () => {
        AD_MODAL.style.display = 'none';
        if (window.Android && typeof Android.requestRewardedAd === 'function') {
          const tag = JSON.stringify(pendingPayload);
          console.log('‚Üí requestRewardedAd(tag) =', tag);
          Android.requestRewardedAd(tag);
        } else {
          console.log('‚ùé No Android bridge ‚Äì opening PDF directly');
          openFullscreenPDF(pendingPayload.title, pendingPayload.url);
          pendingPayload = null;
        }
      });

      // -----------------------------------------------------------------
      // ‚ÄúCancel‚Äù button ‚Äì hide modal & discard payload
      // -----------------------------------------------------------------
      CANCEL_BTN.addEventListener('click', () => {
        console.log('‚úñÔ∏è User cancelled ‚Äì dropping pendingPayload');
        AD_MODAL.style.display = 'none';
        pendingPayload = null;
      });

      // -----------------------------------------------------------------
      // Data fetching & UI building (unchanged)
      // -----------------------------------------------------------------
      async function fetchData() {
        try {
          console.log('üì¶ fetching data from backend ‚Üí', BACKEND_URL);
          const res  = await fetch(BACKEND_URL);
          const data = await res.json();
          LOADER.style.display = 'none';

          if (!data || data.length === 0) {
            FEED.innerHTML = "<p style='text-align:center;color:#94a3b8'>No PDFs found üò¢</p>";
            console.warn('‚ö†Ô∏è Backend returned empty array');
            return;
          }

          allData = data.sort((a, b) => Number(b.id) - Number(a.id));
          loadNextBatch();
          window.addEventListener('scroll', handleScroll);
        } catch (err) {
          LOADER.style.display = 'none';
          FEED.innerHTML = "<p style='text-align:center;color:#f87171'>Error loading data üòû</p>";
          console.error('‚ùå fetchData error ‚Üí', err);
        }
      }

      function loadNextBatch() {
        if (loadingMore) return;
        loadingMore = true;

        const nextBatch = allData.slice(currentIndex, currentIndex + BATCH_SIZE);
        console.log('üîÄ loading next batch ‚Äì items', currentIndex, 'to', currentIndex + BATCH_SIZE);
        nextBatch.forEach(item => createCard(item));

        currentIndex += BATCH_SIZE;
        loadingMore = false;

        if (currentIndex >= allData.length) {
          window.removeEventListener('scroll', handleScroll);
        }
      }

      function createCard(item) {
        const card = document.createElement('div');
        card.className = 'card';

        const preview = document.createElement('div');
        preview.className = 'preview';

        if (item.archive_url && item.archive_url.includes('archive.org')) {
          const embedUrl = item.archive_url.replace('/details/', '/embed/');
          preview.innerHTML = `<iframe src="${embedUrl}" allowfullscreen></iframe>`;
        } else {
          preview.textContent = 'No Preview Available';
        }

        const info = document.createElement('div');
        info.className = 'info';
        info.innerHTML = `
          <div class="title">${item.title || 'Untitled PDF'}</div>
          <div class="meta">üë§ ${item.username || 'Anonymous'} ‚Ä¢ üÜî ${item.id || 'N/A'}</div>
        `;

        const openBtn = document.createElement('button');
        openBtn.className = 'open-btn';
        openBtn.textContent = 'Open PDF';
        openBtn.onclick = () => showAdModal(item);

        card.append(preview, info, openBtn);
        FEED.appendChild(card);
      }

      function handleScroll() {
        const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
        if (scrollTop + clientHeight >= scrollHeight - 10) {
          loadNextBatch();
        }
      }

      // -----------------------------------------------------------------
      // Viewer close handling
      // -----------------------------------------------------------------
      CLOSE_VIEWER.onclick = closeViewer;
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeViewer();
      });

      function closeViewer() {
        VIEWER.classList.remove('active');
        PDF_FRAME.src = '';
      }

      // -----------------------------------------------------------------
      // Initialise ‚Äì preload the rewarded ad (only when Android bridge exists)
      // -----------------------------------------------------------------
      document.addEventListener('DOMContentLoaded', () => {
        if (window.Android && typeof Android.preloadRewardedAd === 'function') {
          console.log('üì¢ pre‚Äëloading rewarded ad');
          Android.preloadRewardedAd();
        } else {
          console.log('üö´ Android bridge not present ‚Äì running in a browser');
        }
        fetchData();
      });
    })();
  </script>
</body>
</html>
