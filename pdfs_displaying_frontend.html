<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>üìö PDF Stream</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
        rel="stylesheet"/>

  <style>
    /* -----------------------------------------------------------------
       General layout & theme
    ----------------------------------------------------------------- */
    * { box-sizing:border-box; margin:0; padding:0; }

    body {
      font-family:'Poppins',sans-serif;
      background:linear-gradient(135deg,#0f172a,#1e293b);
      color:#fff;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding-bottom:40px;
    }

    header{
      width:100%; padding:16px; text-align:center;
      background:rgba(255,255,255,.08);
      backdrop-filter:blur(12px);
      box-shadow:0 4px 20px rgba(0,0,0,.3);
      font-size:1.5em; font-weight:600; color:#60a5fa;
      letter-spacing:1px;
    }

    #feed{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:16px;
      width:92%; max-width:1300px;
      margin-top:24px;
    }

    .card{
      background:rgba(255,255,255,.08);
      border-radius:16px;
      padding:14px;
      display:flex;
      flex-direction:column;
      transition:transform .25s ease,box-shadow .25s ease;
    }
    .card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 20px rgba(0,0,0,.4);
    }

    .preview{
      width:100%; aspect-ratio:16/9;
      border-radius:12px;
      overflow:hidden;
      background:#1e293b;
      display:flex; align-items:center; justify-content:center;
      color:#94a3b8; font-size:.9em;
    }
    .preview iframe{ width:100%; height:100%; border:none; }

    .info{ margin-top:10px; }
    .title{
      font-size:1em; font-weight:600; color:#f8fafc;
      margin-bottom:4px; line-height:1.4; word-break:break-word;
    }
    .meta{
      font-size:.85em; color:#94a3b8; word-break:break-word;
    }

    .open-btn{
      margin-top:10px; background:#60a5fa; color:#fff;
      border:none; border-radius:8px; padding:10px;
      font-weight:500; cursor:pointer;
      transition:background .25s ease; font-size:.95em;
    }
    .open-btn:hover{ background:#3b82f6; }

    footer{
      margin-top:30px; color:#94a3b8; font-size:.9em; text-align:center;
    }

    .loader{
      margin-top:60px;
      border:6px solid rgba(255,255,255,.2);
      border-top:6px solid #60a5fa;
      border-radius:50%; width:45px; height:45px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

    /* -----------------------------------------------------------------
       Full‚Äëscreen PDF viewer
    ----------------------------------------------------------------- */
    .pdf-viewer{
      position:fixed; top:0; left:0;
      width:100vw; height:100vh;
      background:#0f172a;
      z-index:999; display:none; flex-direction:column;
    }
    .pdf-viewer.active{ display:flex; }

    .pdf-toolbar{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 14px;
      background:rgba(15,23,42,.9);
      border-bottom:1px solid rgba(255,255,255,.1);
    }
    .pdf-toolbar h2{
      font-size:1em; color:#93c5fd; font-weight:500;
      overflow:hidden; text-overflow:ellipsis;
      white-space:nowrap; max-width:80%;
    }
    .close-full{
      background:#ef4444; border:none; color:#fff;
      font-size:1.2em; width:36px; height:36px;
      border-radius:50%; cursor:pointer;
      transition:background .25s ease;
    }
    .close-full:hover{ background:#dc2626; }
    .pdf-iframe{
      flex-grow:1; border:none; width:100%; height:100%;
    }

    /* -----------------------------------------------------------------
       Modal (watch‚Äëad popup)
    ----------------------------------------------------------------- */
    .modal{
      position:fixed; top:0; left:0;
      width:100vw; height:100vh;
      background:rgba(0,0,0,.6);
      display:none; justify-content:center; align-items:center;
      z-index:1000;
    }
    .modal-content{
      background:#1e293b;
      padding:20px; border-radius:12px;
      text-align:center; max-width:90%;
    }
    .modal-content p{
      color:#f8fafc; margin-bottom:15px;
    }
    .modal-content button{
      margin:5px; padding:10px 20px;
      border:none; border-radius:6px;
      font-size:.95em; cursor:pointer;
    }
    .btn-watch{ background:#60a5fa; color:#fff; }
    .btn-watch:hover{ background:#3b82f6; }
    .btn-cancel{ background:#64748b; color:#fff; }
    .btn-cancel:hover{ background:#475569; }

    /* -----------------------------------------------------------------
       Responsiveness
    ----------------------------------------------------------------- */
    @media(max-width:768px){
      header{font-size:1.3em;padding:12px}
      .open-btn{font-size:.9em;padding:8px}
      .meta{font-size:.8em}
    }
    @media(max-width:480px){
      #feed{width:96%;gap:12px}
      .card{padding:10px}
      .preview{aspect-ratio:4/3}
      .title{font-size:.95em}
      .pdf-toolbar h2{font-size:.9em}
      .close-full{width:32px;height:32px;font-size:1em}
    }

    /* -----------------------------------------------------------------
       Debug panel (tiny button + overlay)
    ----------------------------------------------------------------- */
    #debugPanel{
      position:fixed; top:0; left:0; right:0; height:200px;
      background:rgba(0,0,0,.85); color:#0f0; font-family:monospace;
      font-size:12px; line-height:1.3; overflow-y:auto; z-index:9999;
      display:none; padding:8px 8px 30px 8px;
    }
    #debugCloseBtn{
      position:absolute; top:4px; right:4px;
      background:#222; color:#fff; border:none; padding:2px 6px;
      font-size:10px; cursor:pointer;
    }
    #debugOpenBtn{
      position:fixed; bottom:12px; right:12px;
      background:#222; color:#0f0; border:none; border-radius:4px;
      padding:6px 10px; font-size:12px; cursor:pointer;
      z-index:9999;
    }
  </style>
</head>
<body>

  <!-- Debug panel -->
  <div id="debugPanel">
    <button id="debugCloseBtn">‚úï</button>
    <div id="debugLog"></div>
  </div>
  <button id="debugOpenBtn">ü™µ Debug</button>

  <!-- Header -->
  <header>üìö PDF Stream</header>

  <!-- Main feed & loader -->
  <div id="feed"></div>
  <div id="loader" class="loader"></div>

  <!-- Footer -->
  <footer>Powered by Archive &amp; Your Backend</footer>

  <!-- Full‚Äëscreen PDF viewer -->
  <div id="pdfViewer" class="pdf-viewer">
    <div class="pdf-toolbar">
      <h2 id="pdfTitle">PDF Viewer</h2>
      <button class="close-full" id="closeViewer">&times;</button>
    </div>
    <iframe id="pdfFrame" class="pdf-iframe" src=""></iframe>
  </div>

  <!-- Watch‚ÄëAd modal -->
  <div id="adModal" class="modal">
    <div class="modal-content">
      <p>Watch an ad to view this PDF</p>
      <button id="watchAdBtn" class="btn-watch">Watch Ad</button>
      <button id="cancelBtn" class="btn-cancel">Cancel</button>
    </div>
  </div>

  <!-- -------------------------------------------------------------
       JavaScript ‚Äì everything (debug console, bridge, callbacks,
       app logic, network interceptors)
       ------------------------------------------------------------- -->
  <script>
    (function () {
      /* ---------------------------------------------------------
         0Ô∏è‚É£ Debug console that writes into the on‚Äëpage panel
         --------------------------------------------------------- */
      const LOG_CONTAINER = document.getElementById('debugLog');
      function dLog(...args) {
        console.__origLog.apply(console, args);
        const line = document.createElement('div');
        line.textContent = args.map(a => {
          try { return typeof a === 'object' ? JSON.stringify(a) : String(a); }
          catch { return String(a); }
        }).join(' ');
        LOG_CONTAINER.appendChild(line);
        LOG_CONTAINER.scrollTop = LOG_CONTAINER.scrollHeight;
      }
      console.__origLog   = console.log   || function () { };
      console.__origWarn  = console.warn  || function () { };
      console.__origError = console.error || function () { };
      console.__origInfo  = console.info  || function () { };
      console.log   = (...a) => dLog('[LOG]',   ...a);
      console.warn  = (...a) => dLog('[WARN]',  ...a);
      console.error = (...a) => dLog('[ERR]',   ...a);
      console.info  = (...a) => dLog('[INFO]',  ...a);

      /* ---------------------------------------------------------
         Debug panel show / hide
         --------------------------------------------------------- */
      const panel    = document.getElementById('debugPanel');
      const openBtn  = document.getElementById('debugOpenBtn');
      const closeBtn = document.getElementById('debugCloseBtn');
      openBtn.addEventListener('click', () => panel.style.display = 'block');
      closeBtn.addEventListener('click', () => panel.style.display = 'none');

      /* ---------------------------------------------------------
         1Ô∏è‚É£ Android bridge wrapper (adds logging)
         --------------------------------------------------------- */
      let android = null;
      if (window.Android) {
        android = {
          requestRewardedAd: window.Android.requestRewardedAd,
          preloadRewardedAd: window.Android.preloadRewardedAd,
          loadUrlInWebView: window.Android.loadUrlInWebView,
          getAndroidId:    window.Android.getAndroidId
        };
        const wrap = (name, fn) => (...args) => {
          console.log(`üîπ Android.${name} called with`, ...args);
          const ret = fn.apply(window.Android, args);
          if (ret !== undefined) console.log(`üîπ Android.${name} returned ‚Üí`, ret);
          return ret;
        };
        window.Android.requestRewardedAd = wrap('requestRewardedAd', android.requestRewardedAd);
        window.Android.preloadRewardedAd = wrap('preloadRewardedAd', android.preloadRewardedAd);
        window.Android.loadUrlInWebView  = wrap('loadUrlInWebView',  android.loadUrlInWebView);
        window.Android.getAndroidId      = wrap('getAndroidId',      android.getAndroidId);
      } else {
        console.warn('‚ö†Ô∏è No Android bridge detected ‚Äì running in a browser');
      }

      /* ---------------------------------------------------------
         2Ô∏è‚É£ Callbacks that the native side will invoke
         --------------------------------------------------------- */
      // Preserve any previous definitions (just in case)
      const _origOnAdPreloaded       = window.onAdPreloaded       || function () { };
      const _origOnAdFailedToPreload = window.onAdFailedToPreload || function () { };
      const _origOnAdNotAvailable    = window.onAdNotAvailable    || function () { };
      const _origOnRewardEarned      = window.onRewardEarned      || function () { };
      const _origOnAdCompleted       = window.onAdCompleted       || function () { };

      window.onAdPreloaded = function () {
        console.log('‚úÖ onAdPreloaded (JS)');
        _origOnAdPreloaded();
      };
      window.onAdFailedToPreload = function () {
        console.warn('‚ö†Ô∏è onAdFailedToPreload (JS)');
        _origOnAdFailedToPreload();
      };
      window.onAdNotAvailable = function () {
        console.warn('‚ö†Ô∏è onAdNotAvailable (JS)');
        // Fallback: open the PDF directly
        if (pendingPayload) {
          openFullscreenPDF(pendingPayload.title, pendingPayload.url);
          pendingPayload = null;
        }
        adInProgress = false;
        _origOnAdNotAvailable();
      };
      window.onRewardEarned = function (tag) {
        console.log('üèÜ onRewardEarned (JS) tag =', tag);
        // `tag` is the JSON we sent from JS ‚Üí Android
        try {
          const payload = JSON.parse(tag);
          // Start a download or any background work while the ad UI is still up
          startPdfDownload(payload);
        } catch (e) {
          console.error('‚ùå onRewardEarned ‚Äì JSON parse error', e);
        }
        _origOnRewardEarned(tag);
      };
      window.onAdCompleted = function (tag, earned) {
        console.log('‚úÖ onAdCompleted (JS) tag =', tag, 'earned =', earned);
        try {
          const payload = JSON.parse(tag);
          if (earned) {
            openFullscreenPDF(payload.title, payload.url);
          } else {
            alert('You need to watch the whole ad to unlock this PDF.');
          }
        } catch (e) {
          console.error('‚ùå onAdCompleted ‚Äì JSON parse error', e);
          // Best‚Äëeffort fallback
          if (pendingPayload) {
            openFullscreenPDF(pendingPayload.title, pendingPayload.url);
          }
        }
        pendingPayload = null;
        adInProgress = false;
        _origOnAdCompleted(tag, earned);
      };

      /* ---------------------------------------------------------
         3Ô∏è‚É£ Network interceptors (debug only)
         --------------------------------------------------------- */
      const origFetch = window.fetch;
      window.fetch = function (...args) {
        console.log('üîó fetch ‚Üí', ...args);
        return origFetch.apply(this, args)
          .then(resp => {
            console.log('üîó fetch response ‚Üí', {
              url: resp.url,
              status: resp.status,
              ok: resp.ok,
              type: resp.type
            });
            return resp;
          })
          .catch(err => {
            console.error('üîó fetch error ‚Üí', err);
            throw err;
          });
      };
      const origXHROpen = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function (method, url, async, user, pwd) {
        this.__debugInfo = { method, url };
        console.log('üîó XHR open ‚Üí', method, url);
        return origXHROpen.apply(this, arguments);
      };
      const origXHRSend = XMLHttpRequest.prototype.send;
      XMLHttpRequest.prototype.send = function (body) {
        const info = this.__debugInfo || {};
        console.log('üîó XHR send ‚Üí', info.method, info.url, 'body:', body);
        this.addEventListener('load', function () {
          console.log('üîó XHR load ‚Üí', {
            url: info.url,
            status: this.status,
            responseURL: this.responseURL,
            responseSnippet: this.responseText?.slice(0, 200)
          });
        });
        this.addEventListener('error', function () {
          console.error('üîó XHR error ‚Üí', info.url);
        });
        return origXHRSend.apply(this, arguments);
      };

      /* ---------------------------------------------------------
         4Ô∏è‚É£ Application logic (feed, modal, ad flow, PDF viewer)
         --------------------------------------------------------- */
      // ----- Global UI elements -------------------------------------------------
      const FEED        = document.getElementById('feed');
      const LOADER      = document.getElementById('loader');
      const VIEWER      = document.getElementById('pdfViewer');
      const PDF_FRAME   = document.getElementById('pdfFrame');
      const PDF_TITLE   = document.getElementById('pdfTitle');
      const CLOSE_VIEWER= document.getElementById('closeViewer');
      const AD_MODAL    = document.getElementById('adModal');
      const WATCH_BTN   = document.getElementById('watchAdBtn');
      const CANCEL_BTN  = document.getElementById('cancelBtn');

      const BACKEND_URL = 'https://pdfs_displaying_backend.video-api-ajaiahar.workers.dev';

      let allData = [], currentIndex = 0;
      const BATCH_SIZE = 30;
      let loadingMore = false;

      // Payload of the PDF the user wants to see (null when no request)
      let pendingPayload = null;
      // Simple lock so we don't fire parallel rewarded‚Äëad requests
      let adInProgress = false;

      // ----- Helper ‚Äì show PDF in full‚Äëscreen viewer -------------------------
      function openFullscreenPDF(title, url) {
        if (!url) {
          console.warn('openFullscreenPDF ‚Äì empty URL');
          return;
        }
        const embedUrl = url.includes('archive.org')
          ? url.replace('/details/', '/embed/')
          : url;
        console.log('üîó embedUrl set on iframe =', embedUrl);
        PDF_TITLE.textContent = title || 'PDF Viewer';
        PDF_FRAME.src = embedUrl;
        VIEWER.classList.add('active');
      }

      // ----- Optional ‚Äì start download while ad is still showing -------------
      function startPdfDownload(payload) {
        console.log('üì• startPdfDownload called with payload =', payload);
        // Example: preload the embed URL so it is cached when the ad finishes
        const embed = payload.url?.includes('archive.org')
          ? payload.url.replace('/details/', '/embed/')
          : payload.url;
        if (embed) {
          const link = document.createElement('link');
          link.rel = 'preload';
          link.as = 'document';
          link.href = embed;
          document.head.appendChild(link);
          console.log('üîó preloading embed URL:', embed);
        }
      }

      // ----- Modal handling -------------------------------------------------
      function showAdModal(item) {
        pendingPayload = {
          title: item.title || 'Untitled PDF',
          url:   item.archive_url || ''
        };
        console.log('üü† showAdModal ‚Äì pendingPayload =', pendingPayload);
        AD_MODAL.style.display = 'flex';
      }

      WATCH_BTN.addEventListener('click', () => {
        AD_MODAL.style.display = 'none';
        if (adInProgress) {
          console.warn('‚ö†Ô∏è Ad already in progress ‚Äì click ignored');
          return;
        }

        if (android && typeof android.requestRewardedAd === 'function') {
          adInProgress = true;               // lock UI
          const tag = JSON.stringify(pendingPayload);
          console.log('‚Üí Android.requestRewardedAd(tag) =', tag);
          android.requestRewardedAd(tag);
        } else {
          console.log('‚ùé No Android bridge ‚Äì opening PDF directly');
          openFullscreenPDF(pendingPayload.title, pendingPayload.url);
          pendingPayload = null;
        }
      });

      CANCEL_BTN.addEventListener('click', () => {
        console.log('‚úñÔ∏è User cancelled ad request');
        AD_MODAL.style.display = 'none';
        pendingPayload = null;
        adInProgress = false;                 // unlock
      });

      // ----- Data fetching + feed rendering ---------------------------------
      async function fetchData() {
        try {
          console.log('üì¶ fetching data from', BACKEND_URL);
          const res = await fetch(BACKEND_URL);
          const data = await res.json();
          LOADER.style.display = 'none';

          if (!Array.isArray(data) || data.length === 0) {
            FEED.innerHTML = "<p style='text-align:center;color:#94a3b8'>No PDFs found üò¢</p>";
            console.warn('‚ö†Ô∏è Backend returned empty array');
            return;
          }

          allData = data.sort((a, b) => Number(b.id) - Number(a.id));
          loadNextBatch();
          window.addEventListener('scroll', handleScroll);
        } catch (err) {
          LOADER.style.display = 'none';
          FEED.innerHTML = "<p style='text-align:center;color:#f87171'>Error loading data üòû</p>";
          console.error('‚ùå fetchData error ‚Üí', err);
        }
      }

      function loadNextBatch() {
        if (loadingMore) return;
        loadingMore = true;

        const nextBatch = allData.slice(currentIndex, currentIndex + BATCH_SIZE);
        console.log('üîÄ loadNextBatch ‚Äì items', currentIndex, 'to', currentIndex + BATCH_SIZE);
        nextBatch.forEach(item => createCard(item));

        currentIndex += BATCH_SIZE;
        loadingMore = false;

        if (currentIndex >= allData.length) {
          window.removeEventListener('scroll', handleScroll);
        }
      }

      function createCard(item) {
        const card = document.createElement('div');
        card.className = 'card';

        const preview = document.createElement('div');
        preview.className = 'preview';
        if (item.archive_url && item.archive_url.includes('archive.org')) {
          const embedUrl = item.archive_url.replace('/details/', '/embed/');
          preview.innerHTML = `<iframe src="${embedUrl}" allowfullscreen></iframe>`;
        } else {
          preview.textContent = 'No Preview Available';
        }

        const info = document.createElement('div');
        info.className = 'info';
        info.innerHTML = `
          <div class="title">${item.title || 'Untitled PDF'}</div>
          <div class="meta">üë§ ${item.username || 'Anonymous'} ‚Ä¢ üÜî ${item.id || 'N/A'}</div>
        `;

        const openBtn = document.createElement('button');
        openBtn.className = 'open-btn';
        openBtn.textContent = 'Open PDF';
        openBtn.onclick = () => showAdModal(item);

        card.append(preview, info, openBtn);
        FEED.appendChild(card);
      }

      function handleScroll() {
        const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
        if (scrollTop + clientHeight >= scrollHeight - 10) {
          loadNextBatch();
        }
      }

      // ----- Viewer close handling -----------------------------------------
      CLOSE_VIEWER.onclick = closeViewer;
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeViewer();
      });
      function closeViewer() {
        VIEWER.classList.remove('active');
        PDF_FRAME.src = '';
      }

      // ----- Init: preload ad (if possible) + fetch data --------------------
      document.addEventListener('DOMContentLoaded', () => {
        if (android && typeof android.preloadRewardedAd === 'function') {
          console.log('üì¢ pre‚Äëloading rewarded ad');
          android.preloadRewardedAd();
        } else {
          console.log('üö´ Android bridge not present ‚Äì running in a browser');
        }
        fetchData();
      });
    })();
  </script>
</body>
</html>
